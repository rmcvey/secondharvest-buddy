<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Delivery</title>
    <style>
      body {
        font-family: Arial, Helvetica, sans-serif;
        font-size: 1rem;
        margin: 0;
        padding: 0;
        display: flex;
        flex-direction: column;
        height: 100vh;
      }
      main {
        flex-grow: 0.5;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        text-align: center;
      }
      form {
        box-sizing: border-box;
        display: flex;
        flex-direction: column;
        width: 300px;
        height: 200px;
        margin: auto;
        align-items: baseline;
        justify-content: space-between;
      }
      form h3 {
        margin-bottom: 0;
      }
      form input[type="password"] {
        padding: 5px;
        border: 1px solid #efefef;
        border-radius: 5px;
        width: 100%;
      }
      form input[type="submit"] {
        background-color: rgb(81, 81, 176);
        border: 1px solid rgb(81, 81, 176);
        color: white;
        padding: 5px 10px;
        border-radius: 5px;
      }
      #current p {
        padding: 2px 15px;
        font-size: 1.1rem;
      }
      #current a,
      #current a:visited {
        color: blue;
      }
      .address {
        font-size: 1.5rem;
      }
      footer {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        box-sizing: border-box;
        height: 10vh;
        width: 100%;
        font-size: 1.5rem;
        display: flex;
        align-items: center;
        justify-content: space-between;
        background: #f8f8f8;
      }
      h2 {
        font-size: 3rem;
        font-weight: 100;
      }
      footer span {
        cursor: pointer;
        margin: 0 20px;
      }
      sup {
        font-size: 1rem;
      }
      .hide {
        display: none;
      }
      a {
        text-underline-offset: 5px;
      }
      .phone {
        border: 1px solid #efefef;
        padding: 10px 15px;
        display: inline-flex;
        justify-content: space-between;
        align-items: center;
        box-sizing: border-box;
        text-decoration: none;
        color: #333;
        border-radius: 3px;
        background-color: rgb(255, 255, 255);
        box-shadow: rgba(50, 50, 93, 0.25) 0 6px 12px -2px, rgba(0, 0, 0, 0.3) 0 3px 7px -3px;
        box-shadow: rgba(0, 0, 0, 0.12) 0 1px 3px, rgba(0, 0, 0, 0.24) 0 1px 2px;
      }
      .phone svg {
        margin-right: 5px;
      }
      #phone-lang {
        display: flex;
        justify-content: center;
        align-items: center;
      }
      .language {
        margin-left: 10px;
      }
    </style>
  </head>
  <body>
    <form id="upload-form" enctype="multipart/form-data">
      <h3>Second Harvest Delivery Helper</h3>
      <aside class="hide">Uploading...</aside>
      <input type="file" id="file-input" accept=".pdf" required="required"/>
      <input placeholder="file password" type="password" name="password" required="required"/>
      <input type="submit" value="Upload PDF"/>
    </form>
    <main class="hide" id="app"></main>
    <footer class="hide">
      <span>&lsaquo;</span><span>&rsaquo;</span></footer>
    <script type="text/javascript">
      let deliveries = [];

      function populate(row) {
        const name = row["First Name"];
        const instructions = row["Delivery Instructions"] ?? '';
        const { City: city, Language: language, Phone: phone, Street: address, Zip: zip } = row;
        return `
        <div id="current">
          <h1>${index + 1} <sup> / ${deliveries.length}</sup></h1>
          <h2>${name}</h2>
          <a class="address" href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(
            `${address} ${city}, ${zip}`
          )}">${address}</a>
          <br /><br /><br />
          <div id="phone-lang">
            <a class="phone" href="tel:+1${phone}"><svg width="24" height="24" viewBox="0 0 24 24" focusable="false" class=" NMm5M"><path d="M16.02 14.46l-2.62 2.62a16.141 16.141 0 0 1-6.5-6.5l2.62-2.62a.98.98 0 0 0 .27-.9L9.15 3.8c-.1-.46-.51-.8-.98-.8H4.02c-.56 0-1.03.47-1 1.03a17.92 17.92 0 0 0 2.43 8.01 18.08 18.08 0 0 0 6.5 6.5 17.92 17.92 0 0 0 8.01 2.43c.56.03 1.03-.44 1.03-1v-4.15c0-.48-.34-.89-.8-.98l-3.26-.65c-.33-.07-.67.04-.91.27z"></path></svg> ${phone}</a>
            <span class="language">${language || "English"}</span>
          </div>
          <br /><br />
          <p>${(instructions).replace(/["]{2,}/g, '"')}</p>
        </div>
      `;
      }

      const HIDE = "hide";
      const form = document.getElementById("upload-form");
      const password = form.querySelector('input[type="password"]');
      const fileInput = document.getElementById("file-input");

      if (sessionStorage.getItem('password')) {
        password.value = sessionStorage.getItem('password');
      }
      
      let index = 0;
      form.addEventListener("submit", function (event) {
        event.preventDefault();
        form.querySelector("aside.hide").classList.remove(HIDE);
        // Check if the file is a PDF
        const file = fileInput.files[0];
        if (file.type !== "application/pdf") {
          alert("Please select a PDF file.");
          return;
        }

        
        if (password) {
          window.sessionStorage.setItem('password', password.value);
        }
        // Prepare FormData
        const formData = new FormData();
        formData.append("password", password.value);
        formData.append("file", file);

        // Send the request
        fetch("/upload", {
          method: "POST",
          body: formData,
        })
          .then((response) => response.json())
          .then((data) => {
            deliveries = data;
            form.classList.add(HIDE);
            document.querySelector("footer").classList.remove(HIDE);
            const app = document.querySelector("#app");
            app.classList.remove(HIDE);
            const spans = document.querySelectorAll("footer span");
            spans[0].addEventListener("click", (e) => {
              if (index > 0) {
                index -= 1;
              } else {
                index = data.length - 1;
              }
              app.innerHTML = populate(data[index]);
            });
            spans[1].addEventListener("click", (e) => {
              if (index < data.length - 1) {
                index += 1;
              } else {
                index = 0;
              }
              app.innerHTML = populate(data[index]);
            });

            app.innerHTML = populate(data[index]);
          })
          .catch((error) => {
            console.error("Error:", error);
          });
      });
    </script>
  </body>
</html>